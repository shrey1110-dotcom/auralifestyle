// src/pages/ProductPage.jsximport React, { useMemo, useRef, useEffect, useState } from "react";import { useParams, useLocation } from "react-router-dom";import { useStore } from "../context/StoreContext";import { useToast } from "../context/ToastContext";import KebabMenu from "../components/KebabMenu";import ALL_PRODUCTS from "../data/products";//import IKImg from "@/components/IKImg";import IKImg from "@/components/IKImg";/* ---------- helpers ---------- */const slugify = (s = "") =>  s    .toString()    .trim()    .toLowerCase()    .replace(/[^a-z0-9]+/g, "-")    .replace(/(^-|-$)+/g, "");const getParamKey = (params, location) => {  const first = Object.keys(params)[0];  let key = first ? params[first] : null;  if (!key && location?.search) {    const q = new URLSearchParams(location.search);    key = q.get("id") || q.get("slug") || q.get("key");  }  return key ? decodeURIComponent(String(key)) : null;};const formatINR = (n) =>  new Intl.NumberFormat("en-IN", {    style: "currency",    currency: "INR",    maximumFractionDigits: 0,  }).format(Math.max(0, Math.round(Number(n || 0))));/* ---------- Size Recommender ---------- */function SizeRecommender({ onPick, product }) {  const [height, setHeight] = useState("");  const [weight, setWeight] = useState("");  const [fit, setFit] = useState("true");  const recommend = useMemo(() => {    const h = Number(height);    const w = Number(weight);    const sizes = product?.sizes || [];    if (!h || !w || !sizes.length) return null;    const order = ["XS", "S", "M", "L", "XL", "XXL", "XXXL"].filter((s) =>      sizes.includes(s)    );    const mid = Math.floor((order.length - 1) / 2);    let idx = mid;    if (h < 165) idx -= 1;    else if (h > 180) idx += 1;    if (w < 55) idx -= 1;    else if (w > 80) idx += 1;    else if (w > 92) idx += 2;    if (fit === "relaxed") idx += 1;    if (fit === "snug") idx -= 1;    idx = Math.max(0, Math.min(order.length - 1, idx));    return order[idx] || null;  }, [height, weight, fit, product?.sizes]);  return (    <div className="rounded-xl border border-neutral-200 dark:border-neutral-800 p-4">      <div className="font-semibold">Size Recommender</div>      <div className="grid grid-cols-2 gap-3 mt-2">        <label className="text-sm">          Height (cm)          <input            className="mt-1 w-full rounded border bg-transparent px-3 py-2"            value={height}            onChange={(e) => setHeight(e.target.value.replace(/[^\d]/g, ""))}            placeholder="e.g. 175"          />        </label>        <label className="text-sm">          Weight (kg)          <input            className="mt-1 w-full rounded border bg-transparent px-3 py-2"            value={weight}            onChange={(e) => setWeight(e.target.value.replace(/[^\d]/g, ""))}            placeholder="e.g. 72"          />        </label>      </div>      <div className="mt-2 flex gap-2 text-sm">        {["snug", "true", "relaxed"].map((k) => (          <button            key={k}            type="button"            onClick={() => setFit(k)}            className={`px-3 py-1 rounded border ${              fit === k ? "bg-neutral-900 text-white dark:bg-white dark:text-neutral-900" : ""            }`}          >            {k === "true" ? "True to size" : k[0].toUpperCase() + k.slice(1)}          </button>        ))}      </div>      <div className="mt-3 text-sm opacity-80">Enter height &amp; weight to get a recommendation.</div>      {recommend && (        <div className="mt-3 flex items-center justify-between">          <div className="text-sm">            Recommended size: <span className="font-semibold">{recommend}</span>          </div>          <button            type="button"            onClick={() => onPick?.(recommend)}            className="px-3 py-1 rounded bg-neutral-900 text-white dark:bg-white dark:text-neutral-900"          >            Pick {recommend}          </button>        </div>      )}    </div>  );}/* ---------- page ---------- */export default function ProductPage() {  const params = useParams();  const location = useLocation();  const key = getParamKey(params, location);  const { getProductSync, products: ctxProducts, addToCart, toggleWishlist, wishlist } = useStore();  const { show } = useToast();  const topRef = useRef(null);  const products = (Array.isArray(ctxProducts) && ctxProducts.length ? ctxProducts : ALL_PRODUCTS) || [];  const product = useMemo(() => {    if (!key) return null;    let found = typeof getProductSync === "function" ? getProductSync(key) : null;    if (found) return found;    const k = String(key).toLowerCase();    const byAnyKey = (p) => {      const title = p?.title || p?.name || "";      const titleSlug = slugify(title);      return (        String(p?.id) === String(key) ||        String(p?.slug || "").toLowerCase() === k ||        String(p?.handle || "").toLowerCase() === k ||        String(p?.sku || "").toLowerCase() === k ||        titleSlug === k      );    };    return products.find(byAnyKey) || null;  }, [getProductSync, products, key]);  useEffect(() => topRef.current?.scrollIntoView({ behavior: "auto" }), [key]);  if (!product) {    return (      <div ref={topRef} className="max-w-6xl mx-auto px-4 py-14 min-h-[60vh]">        <p className="text-lg font-medium">Product not found.</p>        <p className="opacity-70 text-sm mt-1">Check your link or try again from the catalog.</p>      </div>    );  }  const title = product.title || product.name || "Product";  const subtitle =    product.subtitle ||    ((product.gender || "").toLowerCase() === "women" ? "Athleisure Bottoms" : "Athleisure Bottoms");  // treat product.id as SKU if product.sku is absent  const sku = String(product.sku || product.id || "").trim();  const colorList = product.colors || [];  const swatches = product.colorSwatches || {};  const [color, setColor] = useState(colorList[0] || "Default");  // Build gallery candidates  const gallery =    product.imagesByColor?.[color] ||    (Array.isArray(product.images) && product.images.length ? product.images : [product.image].filter(Boolean));  const coverCandidate =    (gallery && gallery[0]) ||    product.image ||    product.cover ||    "/images/placeholder.jpg";  const [cover, setCover] = useState(coverCandidate);  useEffect(() => setCover(coverCandidate), [coverCandidate]);  // ----- arrows + keyboard for gallery -----  const hasMany = Array.isArray(gallery) && gallery.length > 1;  const currentIndex = Math.max(0, gallery.findIndex((src) => src === cover));  const prevImage = () => {    if (!hasMany) return;    const i = currentIndex <= 0 ? gallery.length - 1 : currentIndex - 1;    setCover(gallery[i]);  };  const nextImage = () => {    if (!hasMany) return;    const i = currentIndex >= gallery.length - 1 ? 0 : currentIndex + 1;    setCover(gallery[i]);  };  function onGalleryKeyDown(e) {    if (!hasMany) return;    if (e.key === "ArrowLeft") prevImage();    if (e.key === "ArrowRight") nextImage();  }  const sizeList = product.sizes || ["S", "M", "L", "XL"];  const [size, setSize] = useState(sizeList[0]);  useEffect(() => setSize(sizeList[0]), [product, color]);  const [qty, setQty] = useState(1);  // ----- INVENTORY -----  const [stock, setStock] = useState(null); // null = unknown; number = available units  const [checking, setChecking] = useState(false);  const checkStock = async (_sku = sku, _qty = 1) => {    if (!_sku) return;    try {      setChecking(true);      const res = await fetch("/api/inventory/check", {        method: "POST",        headers: { "Content-Type": "application/json" },        body: JSON.stringify({ items: [{ sku: _sku, qty: _qty }] }),      });      const data = await res.json();      const available = (data?.stock && typeof data.stock[_sku] === "number") ? data.stock[_sku] : null;      setStock(available);    } catch {      setStock(null);    } finally {      setChecking(false);    }  };  useEffect(() => {    // refresh stock on product change    checkStock(sku, qty);    // eslint-disable-next-line react-hooks/exhaustive-deps  }, [sku]);  useEffect(() => {    // keep qty in bounds if stock known    if (typeof stock === "number" && qty > stock) {      setQty(Math.max(1, stock));    }  }, [stock, qty]);  const stockLabel = (() => {    if (stock === 0) return "Out of stock";    if (stock === 1) return "Only 1 left!";    if (stock === 2) return "Few left";    if (typeof stock === "number") return `${stock} in stock`;    return checking ? "Checking stock…" : null;  })();  const wished = Array.isArray(wishlist) && wishlist.some((w) => String(w.id) === String(product.id));  const { addToCart: addToCartCtx } = useStore();  const addItem = async () => {    // re-check right before adding    await checkStock(sku, qty);    if (stock === 0) {      show("Out of stock", { type: "error", timeout: 1400 });      return;    }    if (typeof stock === "number" && qty > stock) {      show(`Only ${stock} available`, { type: "error", timeout: 1400 });      return;    }    addToCartCtx?.({      id: product.id, // keep using product.id through the app      title,      price: Number(product.price || 0) || 1,      mrp: Number(product.mrp || product.price || 0) || 1,      image: cover,      qty,      size,      color,      // (optional) also stash sku inside cart line      sku,    });    show("Added to bag", {      type: "cart",      subtitle: `${title}${size ? ` • ${size}` : ""}${color ? ` • ${color}` : ""}`,      timeout: 1600,    });  };  const onImgError = (e) => {    if (e?.target?.src && !e.target.src.endsWith("/images/placeholder.jpg")) {      e.target.src = "/images/placeholder.jpg";    }  };  return (    <div ref={topRef} className="max-w-6xl mx-auto px-4 py-10">      {/* top row: page actions */}      <div className="flex items-center justify-between mb-4">        <div className="text-sm opacity-70">{subtitle}</div>        <KebabMenu />      </div>      <div className="grid lg:grid-cols-2 gap-10">        {/* left: image / gallery */}        <div>          <div className="relative" tabIndex={0} onKeyDown={onGalleryKeyDown}>            {stock === 0 && (              <div className="absolute left-3 top-3 z-10 px-2 py-1 rounded-md bg-red-600 text-white text-xs font-semibold">                SOLD OUT              </div>            )}            <IKImg              key={cover} // force rerender when switching color/images              src={cover}              alt={title}              onError={onImgError}              className="w-full rounded-xl object-cover border border-neutral-200 dark:border-neutral-800"              width={1200}              height={1600}              sizes="(min-width:1024px) 640px, 100vw"            />            {/* ← / → arrows */}            {hasMany && (              <>                <button                  type="button"                  onClick={prevImage}                  aria-label="Previous image"                  className="absolute left-2 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full border border-neutral-200 bg-white/90 dark:bg-neutral-900/70 backdrop-blur text-xl leading-10 text-center shadow hover:bg-white"                >                  ‹                </button>                <button                  type="button"                  onClick={nextImage}                  aria-label="Next image"                  className="absolute right-2 top-1/2 -translate-y-1/2 h-10 w-10 rounded-full border border-neutral-200 bg-white/90 dark:bg-neutral-900/70 backdrop-blur text-xl leading-10 text-center shadow hover:bg-white"                >                  ›                </button>              </>            )}          </div>          {/* thumbs */}          {Array.isArray(gallery) && gallery.length > 1 && (            <div className="mt-3 grid grid-cols-5 gap-2">              {gallery.map((src, i) => (                <button                  key={src}                  type="button"                  onClick={() => setCover(src)}                  className={`rounded-lg border overflow-hidden ${i === currentIndex ? "ring-2 ring-neutral-900" : ""}`}                  aria-label={`Gallery thumbnail ${i + 1}`}                >                  <IKImg                    src={src}                    alt={`${title} thumb`}                    width={240}                    height={320}                    className="w-full aspect-[3/4] object-cover"                    onError={onImgError}                  />                </button>              ))}            </div>          )}        </div>        {/* right: content */}        <div>          <h1 className="text-2xl md:text-3xl font-bold">{title}</h1>          <div className="mt-1 flex items-center gap-3">            <div className="text-xl md:text-2xl font-semibold">{formatINR(product.price)}</div>            {product.mrp && product.mrp > product.price && (              <div className="opacity-60 line-through">{formatINR(product.mrp)}</div>            )}          </div>          {/* Stock pill */}          {stockLabel && (            <div              className={`mt-2 inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs ${                stock === 0                  ? "bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300"                  : "bg-emerald-50 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300"              }`}            >              <span className="inline-block h-2 w-2 rounded-full bg-current opacity-70" />              {stockLabel}            </div>          )}          {/* Color */}          {colorList.length > 0 && (            <div className="mt-4">              <div className="text-sm font-medium">                Color: <span className="opacity-80">{color}</span>              </div>              <div className="flex gap-2 mt-2">                {colorList.map((c) => (                  <button                    key={c}                    type="button"                    onClick={() => setColor(c)}                    className={`h-7 w-7 rounded-full border ${                      color === c ? "ring-2 ring-offset-2 ring-black" : ""                    }`}                    title={c}                    aria-label={c}                    style={{ background: swatches[c] || "#e5e5e5" }}                  />                ))}              </div>            </div>          )}          {/* Size */}          <div className="mt-4">            <div className="text-sm font-medium">Size</div>            <div className="flex flex-wrap gap-2 mt-2">              {sizeList.map((s) => (                <button                  key={s}                  type="button"                  onClick={() => setSize(s)}                  className={`px-4 py-2 rounded border ${                    size === s ? "bg-neutral-900 text-white dark:bg-white dark:text-neutral-900" : ""                  }`}                >                  {s}                </button>              ))}            </div>          </div>          {/* Quantity */}          <div className="mt-4">            <div className="text-sm font-medium">Quantity</div>            <div className="inline-flex items-center border rounded mt-2">              <button                type="button"                className="px-3 py-1"                onClick={() => setQty((q) => Math.max(1, q - 1))}              >                −              </button>              <input                className="w-16 text-center py-1 bg-transparent outline-none"                value={qty}                onChange={(e) => {                  const val = Math.max(1, Math.min(99, Number(e.target.value) || 1));                  setQty(val);                  if (typeof stock === "number" && val > stock) setQty(stock || 1);                }}              />              <button                type="button"                className="px-3 py-1"                onClick={() =>                  setQty((q) => {                    const v = Math.min(99, q + 1);                    if (typeof stock === "number") return Math.min(stock || 1, v);                    return v;                  })                }              >                +              </button>            </div>          </div>          {/* Actions */}          <div className="mt-4 flex gap-3">            <button              type="button"              onClick={addItem}              disabled={stock === 0 || checking}              className={`px-5 py-2 rounded ${                stock === 0                  ? "bg-neutral-300 text-neutral-600 cursor-not-allowed"                  : "bg-neutral-900 text-white dark:bg-white dark:text-neutral-900"              }`}            >              {stock === 0 ? "Sold out" : `Add to Cart`}            </button>            <button              type="button"              onClick={() => {                addItem();                if (stock !== 0) {                  show("Item added — proceed to checkout", { type: "cart", timeout: 1400 });                }              }}              disabled={stock === 0 || checking}              className="px-5 py-2 rounded border"            >              Buy Now            </button>            <button              type="button"              onClick={() => {                const wasWished =                  Array.isArray(wishlist) && wishlist.some((w) => String(w.id) === String(product.id));                toggleWishlist?.({ id: product.id, title, price: product.price, image: cover });                show(wasWished ? "Removed from wishlist" : "Added to wishlist", {                  type: "wish",                  subtitle: title,                  timeout: 1600,                });              }}              className={`px-5 py-2 rounded border ${                wished ? "bg-rose-600 text-white border-rose-600" : ""              }`}            >              {wished ? "Wishlisted" : "Wishlist"}            </button>          </div>          {/* Size recommender */}          <div className="mt-6">            <SizeRecommender product={product} onPick={(s) => setSize(s)} />          </div>          {/* Bullets */}          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6 text-sm">            <ul className="space-y-1 list-disc list-inside">              {(product.highlightsLeft || ["Cotton-rich terry", "Secure zip pocket"]).map((b) => (                <li key={b}>{b}</li>              ))}            </ul>            <ul className="space-y-1 list-disc list-inside">              {(product.highlightsRight || ["Elastic waist w/ drawcord", "Tapered ankle"]).map((b) => (                <li key={b}>{b}</li>              ))}            </ul>          </div>          {/* Accordions */}          <div className="mt-6 space-y-3">            <details className="rounded border p-4" open>              <summary className="cursor-pointer font-medium">Description</summary>              <p className="mt-2 text-sm opacity-90">                {product.description ||                  "Tapered joggers with a clean silhouette—soft on skin, structured enough to hold shape. Zippered pocket keeps essentials secure."}              </p>            </details>            <details className="rounded border p-4">              <summary className="cursor-pointer font-medium">Size Chart</summary>              <p className="mt-2 text-sm opacity-90">                Model is 5'9&quot; wearing size M. Measure around chest &amp; waist for the best fit.              </p>            </details>            <details className="rounded border p-4">              <summary className="cursor-pointer font-medium">Fabric &amp; Care</summary>              <ul className="mt-2 text-sm opacity-90 list-disc list-inside space-y-1">                <li>Fabric: 100% Cotton, 220–240 GSM</li>                <li>Machine wash cold with like colours</li>                <li>Do not bleach</li>                <li>Line dry in shade</li>                <li>Cool iron on reverse; do not iron on print</li>              </ul>            </details>          </div>        </div>      </div>    </div>  );}